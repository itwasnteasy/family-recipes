<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Recipe Cards</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
        }

        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        @media (max-width: 768px) {
            .app-container {
                border-radius: 10px;
            }
        }

        .app-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        @media (max-width: 768px) {
            .app-header {
                padding: 20px 15px;
            }
        }

        .app-title {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: normal;
        }

        @media (max-width: 768px) {
            .app-title {
                font-size: 1.8em;
            }
        }

        .app-subtitle {
            font-size: 1.1em;
            opacity: 0.9;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .app-subtitle {
                font-size: 0.9em;
            }
        }

        .nav-bar {
            background: #f8f9fa;
            padding: 15px 30px;
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
            border-bottom: 2px solid #e9ecef;
        }

        @media (max-width: 768px) {
            .nav-bar {
                padding: 12px 15px;
                gap: 8px;
            }
        }

        .nav-btn {
            padding: 10px 20px;
            background: white;
            border: 2px solid #667eea;
            border-radius: 25px;
            color: #667eea;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1em;
        }

        @media (max-width: 768px) {
            .nav-btn {
                padding: 10px 15px;
                font-size: 0.9em;
            }
        }

        .nav-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
        }

        .nav-btn.active {
            background: #667eea;
            color: white;
        }

        .search-bar {
            flex: 1;
            min-width: 200px;
            padding: 10px 20px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 1em;
        }

        @media (max-width: 768px) {
            .search-bar {
                width: 100%;
                min-width: unset;
                padding: 10px 15px;
                font-size: 0.95em;
                flex-basis: 100%;
            }
        }

        .main-content {
            padding: 30px;
            min-height: 500px;
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 15px;
            }
        }

        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 25px;
            animation: fadeIn 0.5s;
        }

        @media (max-width: 768px) {
            .category-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
                gap: 15px;
            }
        }

        .category-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid #f0f0f0;
            position: relative;
            overflow: hidden;
        }

        @media (max-width: 768px) {
            .category-card {
                padding: 20px 15px;
                border-radius: 10px;
            }
        }

        .category-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .category-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            border-color: #667eea;
        }

        .category-actions {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 5px;
            z-index: 10;
        }

        @media (max-width: 768px) {
            .category-actions {
                top: 8px;
                right: 8px;
            }
        }

        .category-action-btn {
            background: white;
            border: 2px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        @media (max-width: 768px) {
            .category-action-btn {
                width: 36px;
                height: 36px;
                font-size: 16px;
            }
        }

        .category-action-btn:hover {
            background: #667eea;
            color: white;
            transform: scale(1.1);
        }

        .category-action-btn.delete {
            border-color: #dc3545;
        }

        .category-action-btn.delete:hover {
            background: #dc3545;
            color: white;
        }

        .category-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        @media (max-width: 768px) {
            .category-icon {
                font-size: 2.5em;
                margin-bottom: 10px;
            }
        }

        .category-name {
            font-size: 1.4em;
            color: #333;
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            .category-name {
                font-size: 1.1em;
                margin-bottom: 5px;
            }
        }

        .category-count {
            color: #666;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .category-count {
                font-size: 0.85em;
            }
        }

        .add-category-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: 3px dashed white;
        }

        .add-category-card::before {
            display: none;
        }

        .add-category-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.4);
            border-color: white;
        }

        .add-category-card .category-icon {
            font-size: 4em;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .add-category-card .category-icon {
                font-size: 3em;
            }
        }

        .recipe-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            animation: fadeIn 0.5s;
        }

        @media (max-width: 768px) {
            .recipe-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }
        }

        .recipe-card {
            background: #fffef5;
            border: 2px solid #e8e4d0;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            min-height: 250px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.1);
        }

        @media (max-width: 768px) {
            .recipe-card {
                padding: 10px;
                min-height: 200px;
            }
        }

        .recipe-card:hover {
            transform: rotate(-2deg) scale(1.05);
            box-shadow: 5px 5px 15px rgba(0, 0, 0, 0.2);
        }

        .recipe-card.multi-card::after {
            content: 'üìö';
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 20px;
        }

        .recipe-card-image {
            width: 100%;
            height: 150px;
            background: #f0f0f0;
            border-radius: 5px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 3em;
            overflow: hidden;
        }

        @media (max-width: 768px) {
            .recipe-card-image {
                height: 120px;
                font-size: 2.5em;
            }
        }

        .recipe-card-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .recipe-title {
            font-size: 1.1em;
            color: #333;
            margin-bottom: 5px;
        }

        @media (max-width: 768px) {
            .recipe-title {
                font-size: 1em;
            }
        }

        .recipe-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            justify-content: center;
        }

        .recipe-tag {
            background: #e9ecef;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.8em;
            color: #666;
        }

        @media (max-width: 768px) {
            .recipe-tag {
                font-size: 0.75em;
                padding: 2px 6px;
            }
        }

        .favorite-star {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 1.5em;
            color: #ffd700;
            cursor: pointer;
            z-index: 10;
        }

        @media (max-width: 768px) {
            .favorite-star {
                font-size: 1.8em;
                top: 8px;
                left: 8px;
            }
        }

        .favorite-star.unfilled {
            color: transparent;
            -webkit-text-stroke: 2px #667eea;
        }

        .favorite-star:hover {
            transform: scale(1.2);
        }

        .add-recipe-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: 3px dashed white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 250px;
        }

        @media (max-width: 768px) {
            .add-recipe-card {
                min-height: 200px;
            }
        }

        .add-recipe-card:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        .add-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            .add-icon {
                font-size: 2.5em;
            }
        }

        .back-btn {
            margin-bottom: 20px;
            padding: 10px 20px;
            background: white;
            border: 2px solid #667eea;
            border-radius: 25px;
            color: #667eea;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1em;
        }

        @media (max-width: 768px) {
            .back-btn {
                padding: 12px 20px;
                font-size: 1.05em;
                margin-bottom: 15px;
            }
        }

        .back-btn:hover {
            background: #667eea;
            color: white;
        }

        .recipe-detail {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 1000px;
            margin: 0 auto;
            animation: fadeIn 0.5s;
        }

        @media (max-width: 768px) {
            .recipe-detail {
                padding: 15px;
                border-radius: 10px;
            }
        }

        .recipe-detail-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }

        @media (max-width: 768px) {
            .recipe-detail-header {
                margin-bottom: 20px;
                padding-bottom: 15px;
            }
        }

        .recipe-detail-title {
            font-size: 2em;
            color: #333;
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            .recipe-detail-title {
                font-size: 1.5em;
            }
        }

        .recipe-cards-container {
            display: flex;
            flex-direction: column;
            gap: 40px;
        }

        @media (max-width: 768px) {
            .recipe-cards-container {
                gap: 25px;
            }
        }

        .card-section {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            background: #fafafa;
        }

        @media (max-width: 768px) {
            .card-section {
                padding: 15px;
            }
        }

        .card-section-title {
            font-size: 1.3em;
            color: #667eea;
            margin-bottom: 15px;
            text-align: center;
        }

        @media (max-width: 768px) {
            .card-section-title {
                font-size: 1.2em;
            }
        }

        .card-images {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        @media (max-width: 768px) {
            .card-images {
                grid-template-columns: 1fr;
                gap: 15px;
            }
        }

        .recipe-image-container {
            flex: 1;
        }

        .recipe-image-full {
            width: 100%;
            height: 500px;
            background: #f8f8f8;
            border: 3px solid #e8e4d0;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            color: #999;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            user-select: none;
        }

        @media (max-width: 768px), (max-width: 1024px) and (max-height: 768px) {
            .recipe-image-full {
                height: auto;
                min-height: 300px;
                max-height: 70vh;
            }
        }

        .recipe-image-full img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .image-controls {
            position: absolute;
            bottom: 10px;
            right: 10px;
            display: flex;
            gap: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            flex-wrap: wrap;
        }

        @media (max-width: 768px), (max-width: 1024px) and (max-height: 768px) {
            .image-controls {
                display: none;
            }
        }

        .control-btn {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s;
        }

        @media (max-width: 768px) {
            .control-btn {
                width: 42px;
                height: 42px;
                font-size: 20px;
            }
        }

        .control-btn:hover {
            background: #764ba2;
            transform: scale(1.1);
        }

        .brightness-slider {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .brightness-slider input {
            width: 100px;
        }

        @media (max-width: 768px) {
            .brightness-slider input {
                width: 80px;
            }
        }

        .image-label {
            position: absolute;
            top: 10px;
            left: 10px;
            background: #667eea;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9em;
            z-index: 1;
        }

        @media (max-width: 768px) {
            .image-label {
                font-size: 0.85em;
                padding: 4px 8px;
            }
        }

        .recipe-action-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
            margin: 20px 0;
        }

        .recipe-action-btn {
            padding: 12px 22px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 1.05em;
            transition: all 0.3s;
        }

        @media (max-width: 768px) {
            .recipe-action-btn {
                padding: 14px 24px;
                font-size: 1.1em;
                min-width: 120px;
            }
        }

        .recipe-action-btn.edit {
            background: #28a745;
            color: white;
        }

        .recipe-action-btn.edit:hover {
            background: #218838;
        }

        .recipe-action-btn.delete {
            background: #dc3545;
            color: white;
        }

        .recipe-action-btn.delete:hover {
            background: #c82333;
        }

        .fullscreen-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .fullscreen-overlay.active {
            display: flex;
        }

        .fullscreen-overlay img {
            max-width: 95%;
            max-height: 95%;
            object-fit: contain;
            touch-action: manipulation;
        }

        .fullscreen-wake-lock {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 2001;
            background: white;
            border: 3px solid #667eea;
            border-radius: 50px;
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1em;
        }

        @media (max-width: 768px), (max-width: 1024px) and (max-height: 768px) {
            .fullscreen-wake-lock {
                bottom: 80px;
                right: 15px;
                padding: 14px 18px;
            }
        }

        .fullscreen-wake-lock:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }

        .fullscreen-wake-lock.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.6), 0 4px 15px rgba(0, 0, 0, 0.3);
            animation: pulse 2s infinite;
        }

        .fullscreen-wake-lock .icon {
            font-size: 1.3em;
        }

        .fullscreen-wake-lock .status-text {
            font-weight: bold;
        }

        @media (max-width: 768px), (max-width: 1024px) and (max-height: 768px) {
            .fullscreen-wake-lock .status-text {
                display: none;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }

        @media (max-width: 768px) {
            .modal {
                padding: 0;
            }
        }

        .modal.active {
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding-top: 40px;
        }

        @media (max-width: 768px) {
            .modal.active {
                padding-top: 0;
                align-items: stretch;
            }
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s;
        }

        @media (max-width: 768px) {
            .modal-content {
                border-radius: 0;
                padding: 20px 15px;
                max-height: 100vh;
                height: 100%;
            }
        }

        .modal-header {
            font-size: 1.8em;
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }

        @media (max-width: 768px) {
            .modal-header {
                font-size: 1.4em;
                margin-bottom: 15px;
            }
        }

        .form-group {
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .form-group {
                margin-bottom: 15px;
            }
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .form-label {
                font-size: 0.95em;
            }
        }

        .form-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1em;
        }

        @media (max-width: 768px) {
            .form-input {
                padding: 12px;
                font-size: 16px;
            }
        }

        .form-select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1em;
            background: white;
        }

        @media (max-width: 768px) {
            .form-select {
                padding: 12px;
                font-size: 16px;
            }
        }

        .cards-section {
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            background: #f8f9ff;
        }

        @media (max-width: 768px) {
            .cards-section {
                padding: 15px;
            }
        }

        .card-upload-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            background: white;
        }

        @media (max-width: 768px) {
            .card-upload-section {
                margin-bottom: 20px;
                padding: 12px;
            }
        }

        .card-upload-title {
            font-size: 1.2em;
            color: #667eea;
            margin-bottom: 15px;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .card-upload-title {
                font-size: 1.1em;
            }
        }

        .card-sides {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 768px) {
            .card-sides {
                gap: 10px;
            }
        }

        .side-upload {
            display: flex;
            flex-direction: column;
        }

        .side-label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .image-upload-area {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            background: white;
            min-height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @media (max-width: 768px) {
            .image-upload-area {
                padding: 15px;
                min-height: 130px;
            }
        }

        .image-upload-area:hover {
            background: #f8f9fa;
        }

        .image-upload-area.has-image {
            border-style: solid;
            padding: 10px;
        }

        .image-preview {
            max-width: 100%;
            max-height: 130px;
            border-radius: 5px;
        }

        @media (max-width: 768px) {
            .image-preview {
                max-height: 110px;
            }
        }

        .remove-image {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            z-index: 10;
        }

        @media (max-width: 768px) {
            .remove-image {
                width: 32px;
                height: 32px;
                font-size: 18px;
            }
        }

        .remove-image:hover {
            background: #ff6666;
            transform: scale(1.1);
        }

        .hidden-file-input {
            display: none;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .btn-cancel, .btn-save {
            padding: 10px 25px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
        }

        @media (max-width: 768px) {
            .btn-cancel, .btn-save {
                padding: 14px 28px;
                font-size: 1.05em;
            }
        }

        .btn-cancel {
            background: #e9ecef;
            color: #666;
        }

        .btn-save {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-cancel:hover {
            background: #dee2e6;
        }

        .btn-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .backup-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .backup-buttons {
                flex-direction: column;
            }
        }

        .backup-btn {
            padding: 10px 20px;
            border: 2px solid #667eea;
            border-radius: 25px;
            background: white;
            color: #667eea;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.95em;
        }

        @media (max-width: 768px) {
            .backup-btn {
                padding: 14px 20px;
                font-size: 1em;
            }
        }

        .backup-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
        }

        .wake-lock-toggle {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 100;
            background: white;
            border: 3px solid #667eea;
            border-radius: 50px;
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1em;
        }

        @media (max-width: 768px), (max-width: 1024px) and (max-height: 768px) {
            .wake-lock-toggle {
                bottom: 80px;
                right: 15px;
                padding: 14px 18px;
            }
        }

        .wake-lock-toggle:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .wake-lock-toggle.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.6), 0 4px 15px rgba(0, 0, 0, 0.2);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 0 20px rgba(102, 126, 234, 0.6), 0 4px 15px rgba(0, 0, 0, 0.2);
            }
            50% {
                box-shadow: 0 0 30px rgba(102, 126, 234, 0.8), 0 4px 15px rgba(0, 0, 0, 0.2);
            }
        }

        .wake-lock-toggle .icon {
            font-size: 1.3em;
        }

        .wake-lock-toggle .status-text {
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .wake-lock-toggle .status-text {
                display: none;
            }
        }

        .compression-note {
            background: #e7f3ff;
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            color: #333;
            font-size: 0.9em;
        }

        .storage-note {
            background: #d4edda;
            border: 2px solid #28a745;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            color: #155724;
            font-size: 0.9em;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .storage-note {
                font-size: 0.85em;
                padding: 12px;
            }
        }

        /* Grocery List Styles */
        .add-grocery-btn {
            position: fixed;
            bottom: 30px;
            left: 30px;
            z-index: 100;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 2em;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @media (max-width: 768px), (max-width: 1024px) and (max-height: 768px) {
            .add-grocery-btn {
                bottom: 80px;
                left: 15px;
                width: 56px;
                height: 56px;
            }
        }

        .add-grocery-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }

        .grocery-list-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 800px;
            margin: 0 auto;
        }

        @media (max-width: 768px) {
            .grocery-list-container {
                padding: 15px;
            }
        }

        .grocery-input-section {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }

        @media (max-width: 768px) {
            .grocery-input-section {
                flex-direction: column;
            }
        }

        .grocery-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1em;
        }

        @media (max-width: 768px) {
            .grocery-input {
                padding: 14px;
                font-size: 16px;
            }
        }

        .grocery-add-btn {
            padding: 12px 24px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
        }

        @media (max-width: 768px) {
            .grocery-add-btn {
                padding: 14px;
                font-size: 1.05em;
            }
        }

        .grocery-add-btn:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .grocery-items {
            margin-bottom: 20px;
        }

        .grocery-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            margin-bottom: 10px;
            background: white;
            transition: all 0.3s;
        }

        .grocery-item.checked {
            background: #f8f9fa;
            opacity: 0.6;
        }

        .grocery-item input[type="checkbox"] {
            width: 24px;
            height: 24px;
            margin-right: 15px;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .grocery-item input[type="checkbox"] {
                width: 28px;
                height: 28px;
            }
        }

        .grocery-item-text {
            flex: 1;
            font-size: 1.1em;
        }

        .grocery-item.checked .grocery-item-text {
            text-decoration: line-through;
            color: #999;
        }

        .grocery-item-delete {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s;
        }

        @media (max-width: 768px) {
            .grocery-item-delete {
                width: 36px;
                height: 36px;
                font-size: 20px;
            }
        }

        .grocery-item-delete:hover {
            background: #c82333;
            transform: scale(1.1);
        }

        .grocery-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .grocery-clear-btn {
            padding: 12px 20px;
            border: 2px solid #667eea;
            border-radius: 10px;
            background: white;
            color: #667eea;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
        }

        @media (max-width: 768px) {
            .grocery-clear-btn {
                flex: 1;
                padding: 14px;
                font-size: 1.05em;
            }
        }

        .grocery-clear-btn:hover {
            background: #667eea;
            color: white;
        }

        .grocery-clear-btn.danger {
            border-color: #dc3545;
            color: #dc3545;
        }

        .grocery-clear-btn.danger:hover {
            background: #dc3545;
            color: white;
        }

        .grocery-empty {
            text-align: center;
            padding: 50px 20px;
            color: #999;
        }

        .grocery-empty-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        /* Category Action Dropdown */
        .category-action-menu {
            position: absolute;
            background: white;
            border: 2px solid #667eea;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            min-width: 120px;
            display: none;
        }

        .category-action-menu.active {
            display: block;
        }

        .category-menu-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #e9ecef;
            transition: background-color 0.3s;
            font-size: 0.95em;
        }

        .category-menu-item:last-child {
            border-bottom: none;
        }

        .category-menu-item:hover {
            background-color: #f8f9fa;
        }

        .category-menu-item.edit:hover {
            background-color: #e7f3ff;
            color: #667eea;
        }

        .category-menu-item.delete:hover {
            background-color: #f8d7da;
            color: #dc3545;
        }

        @media (max-width: 768px) {
            .category-menu-item {
                padding: 14px 18px;
                font-size: 1em;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="app-header">
            <h1 class="app-title">Family Recipe Cards</h1>
            <p class="app-subtitle">Preserving our culinary memories, one card at a time</p>
        </div>

        <div class="nav-bar">
            <button class="nav-btn active" onclick="showView('categories')">Categories</button>
            <button class="nav-btn" onclick="showView('all')">All Recipes</button>
            <button class="nav-btn" onclick="showView('favorites')">Favorites</button>
            <button class="nav-btn" onclick="showView('grocery')">üõí Grocery List</button>
            <input type="text" class="search-bar" placeholder="Search recipes..." onkeyup="searchRecipes(this.value)">
        </div>

        <div class="main-content" id="mainContent">
            <div style="text-align: center; padding: 50px;">
                <div style="font-size: 3em; margin-bottom: 20px;">‚è≥</div>
                <div style="font-size: 1.2em; color: #666;">Loading recipes...</div>
            </div>
        </div>

        <div style="padding: 20px 30px; background: #f8f9fa; border-top: 2px solid #e9ecef;">
            <div class="storage-note">
                üíæ Using IndexedDB - Can store 100+ recipes!
            </div>
            <div class="backup-buttons">
                <button class="backup-btn" onclick="exportBackup()">üì• Export Backup</button>
                <button class="backup-btn" onclick="document.getElementById('importFileInput').click()">üì§ Import Backup</button>
                <input type="file" id="importFileInput" accept=".json" style="display: none;" onchange="importBackup(event)">
            </div>
        </div>
    </div>

    <!-- Add Recipe Modal -->
    <div class="modal" id="addRecipeModal">
        <div class="modal-content">
            <h2 class="modal-header">Add New Recipe Card</h2>
            
            <div class="compression-note">
                ‚ú® Images automatically compressed
            </div>

            <div class="form-group">
                <label class="form-label">Recipe Title</label>
                <input type="text" class="form-input" id="recipeTitle" placeholder="Grandma's Apple Pie">
            </div>

            <div class="form-group">
                <label class="form-label">Category</label>
                <select class="form-select" id="recipeCategory">
                    <option value="appetizers">Appetizers</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Tags (comma separated)</label>
                <input type="text" class="form-input" id="recipeTags" placeholder="holiday, grandma's, quick">
            </div>

            <div class="form-group">
                <label class="form-label">Voice Clip URL (optional)</label>
                <input type="text" class="form-input" id="recipeVoiceClip" placeholder="https://example.com/audio/recipe-name.mp3">
                <small style="color: #666; font-size: 0.85em; display: block; margin-top: 5px;">
                    Add a voice recording URL to hear the recipe name spoken
                </small>
            </div>

            <div class="cards-section">
                <h3 style="margin-bottom: 20px; color: #667eea;">Recipe Cards (up to 4)</h3>
                
                <div class="card-upload-section">
                    <div class="card-upload-title">Card 1</div>
                    <div class="card-sides">
                        <div class="side-upload">
                            <div class="side-label">Front</div>
                            <input type="file" class="hidden-file-input" id="card1FrontInput" accept="image/*" onchange="handleCardImageUpload(event, 1, 'front')">
                            <div class="image-upload-area" id="card1FrontArea" onclick="document.getElementById('card1FrontInput').click()">
                                <span>üì∑</span>
                            </div>
                        </div>
                        <div class="side-upload">
                            <div class="side-label">Back (optional)</div>
                            <input type="file" class="hidden-file-input" id="card1BackInput" accept="image/*" onchange="handleCardImageUpload(event, 1, 'back')">
                            <div class="image-upload-area" id="card1BackArea" onclick="document.getElementById('card1BackInput').click()">
                                <span>üì∑</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card-upload-section">
                    <div class="card-upload-title">Card 2 (optional)</div>
                    <div class="card-sides">
                        <div class="side-upload">
                            <div class="side-label">Front</div>
                            <input type="file" class="hidden-file-input" id="card2FrontInput" accept="image/*" onchange="handleCardImageUpload(event, 2, 'front')">
                            <div class="image-upload-area" id="card2FrontArea" onclick="document.getElementById('card2FrontInput').click()">
                                <span>üì∑</span>
                            </div>
                        </div>
                        <div class="side-upload">
                            <div class="side-label">Back (optional)</div>
                            <input type="file" class="hidden-file-input" id="card2BackInput" accept="image/*" onchange="handleCardImageUpload(event, 2, 'back')">
                            <div class="image-upload-area" id="card2BackArea" onclick="document.getElementById('card2BackInput').click()">
                                <span>üì∑</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card-upload-section">
                    <div class="card-upload-title">Card 3 (optional)</div>
                    <div class="card-sides">
                        <div class="side-upload">
                            <div class="side-label">Front</div>
                            <input type="file" class="hidden-file-input" id="card3FrontInput" accept="image/*" onchange="handleCardImageUpload(event, 3, 'front')">
                            <div class="image-upload-area" id="card3FrontArea" onclick="document.getElementById('card3FrontInput').click()">
                                <span>üì∑</span>
                            </div>
                        </div>
                        <div class="side-upload">
                            <div class="side-label">Back (optional)</div>
                            <input type="file" class="hidden-file-input" id="card3BackInput" accept="image/*" onchange="handleCardImageUpload(event, 3, 'back')">
                            <div class="image-upload-area" id="card3BackArea" onclick="document.getElementById('card3BackInput').click()">
                                <span>üì∑</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card-upload-section">
                    <div class="card-upload-title">Card 4 (optional)</div>
                    <div class="card-sides">
                        <div class="side-upload">
                            <div class="side-label">Front</div>
                            <input type="file" class="hidden-file-input" id="card4FrontInput" accept="image/*" onchange="handleCardImageUpload(event, 4, 'front')">
                            <div class="image-upload-area" id="card4FrontArea" onclick="document.getElementById('card4FrontInput').click()">
                                <span>üì∑</span>
                            </div>
                        </div>
                        <div class="side-upload">
                            <div class="side-label">Back (optional)</div>
                            <input type="file" class="hidden-file-input" id="card4BackInput" accept="image/*" onchange="handleCardImageUpload(event, 4, 'back')">
                            <div class="image-upload-area" id="card4BackArea" onclick="document.getElementById('card4BackInput').click()">
                                <span>üì∑</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-buttons">
                <button class="btn-cancel" onclick="closeModal()">Cancel</button>
                <button class="btn-save" onclick="saveRecipe()">Save Recipe</button>
                <button class="btn-cancel" id="deleteRecipeBtn" style="display: none; background: #dc3545; color: white; border-color: #dc3545;" onclick="deleteRecipeFromModal()">üóëÔ∏è Delete Recipe</button>
            </div>
        </div>
    </div>

    <!-- Fullscreen Image Overlay -->
    <div class="fullscreen-overlay" id="fullscreenOverlay" onclick="closeFullscreen()">
        <img id="fullscreenImage" src="" alt="">
        <div class="fullscreen-wake-lock" id="fullscreenWakeLock" onclick="event.stopPropagation(); toggleWakeLock()">
            <span class="icon">‚òÄÔ∏è</span>
            <span class="status-text">Keep Screen On</span>
        </div>
    </div>

    <!-- Category Action Dropdown Menu -->
    <div class="category-action-menu" id="categoryActionMenu">
        <div class="category-menu-item edit" onclick="event.stopPropagation(); editCategoryFromMenu()">‚úèÔ∏è Edit Category</div>
        <div class="category-menu-item delete" onclick="event.stopPropagation(); deleteCategoryFromMenu()">üóëÔ∏è Delete Category</div>
        <div class="category-menu-item" onclick="event.stopPropagation(); closeCategoryMenu()">‚ùå Cancel</div>
    </div>

    <script>
        // IndexedDB Setup
        let db;
        const DB_NAME = 'RecipeCardsDB';
        const DB_VERSION = 2;
        const RECIPES_STORE = 'recipes';
        const CATEGORIES_STORE = 'categories';
        const GROCERY_STORE = 'grocery';

        let recipes = [];
        let categories = {
            appetizers: { name: "Appetizers", icon: "ü•ü", count: 0 },
            mains: { name: "Main Dishes", icon: "üçñ", count: 0 },
            desserts: { name: "Desserts", icon: "üç∞", count: 0 },
            sides: { name: "Side Dishes", icon: "ü•ó", count: 0 },
            soups: { name: "Soups & Stews", icon: "üç≤", count: 0 },
            breads: { name: "Breads & Baking", icon: "üçû", count: 0 }
        };

        let currentView = 'categories';
        let currentCategory = null;
        let currentRecipe = null;
        let previousView = 'categories';
        let previousCategory = null;
        let tempCards = [
            { front: null, back: null },
            { front: null, back: null },
            { front: null, back: null },
            { front: null, back: null }
        ];
        let wakeLock = null;
        let groceryItems = [];

        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    
                    if (!db.objectStoreNames.contains(RECIPES_STORE)) {
                        db.createObjectStore(RECIPES_STORE, { keyPath: 'id' });
                    }
                    
                    if (!db.objectStoreNames.contains(CATEGORIES_STORE)) {
                        db.createObjectStore(CATEGORIES_STORE);
                    }
                    
                    if (!db.objectStoreNames.contains(GROCERY_STORE)) {
                        db.createObjectStore(GROCERY_STORE, { keyPath: 'id' });
                    }
                };
            });
        }

        async function saveRecipesToDB() {
            const tx = db.transaction(RECIPES_STORE, 'readwrite');
            const store = tx.objectStore(RECIPES_STORE);
            await store.clear();
            for (const recipe of recipes) {
                await store.put(recipe);
            }
            return tx.complete;
        }

        async function loadRecipesFromDB() {
            const tx = db.transaction(RECIPES_STORE, 'readonly');
            const store = tx.objectStore(RECIPES_STORE);
            const request = store.getAll();
            
            return new Promise((resolve, reject) => {
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        async function saveCategoriesToDB() {
            const tx = db.transaction(CATEGORIES_STORE, 'readwrite');
            const store = tx.objectStore(CATEGORIES_STORE);
            await store.put(categories, 'categories');
            return tx.complete;
        }

        async function loadCategoriesFromDB() {
            const tx = db.transaction(CATEGORIES_STORE, 'readonly');
            const store = tx.objectStore(CATEGORIES_STORE);
            const request = store.get('categories');
            
            return new Promise((resolve, reject) => {
                request.onsuccess = () => {
                    if (request.result) {
                        resolve(request.result);
                    } else {
                        resolve(categories);
                    }
                };
                request.onerror = () => reject(request.error);
            });
        }

        async function saveGroceryListToDB() {
            const tx = db.transaction(GROCERY_STORE, 'readwrite');
            const store = tx.objectStore(GROCERY_STORE);
            await store.clear();
            for (const item of groceryItems) {
                await store.put(item);
            }
            return tx.complete;
        }

        async function loadGroceryListFromDB() {
            const tx = db.transaction(GROCERY_STORE, 'readonly');
            const store = tx.objectStore(GROCERY_STORE);
            const request = store.getAll();
            
            return new Promise((resolve, reject) => {
                request.onsuccess = () => resolve(request.result || []);
                request.onerror = () => reject(request.error);
            });
        }

        function compressImage(file, maxWidth = 1600, quality = 0.85) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                        resolve(compressedDataUrl);
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        window.onload = async function() {
            try {
                await initDB();
                categories = await loadCategoriesFromDB();
                recipes = await loadRecipesFromDB();
                groceryItems = await loadGroceryListFromDB();
                updateCategoryCounts();
                updateCategoryDropdown();
                showCategories();
            } catch (error) {
                console.error('Error initializing app:', error);
                alert('Error loading app. Please refresh.');
            }
            
            document.addEventListener('visibilitychange', async () => {
                if (wakeLock !== null && document.visibilityState === 'visible') {
                    try {
                        wakeLock = await navigator.wakeLock.request('screen');
                    } catch (err) {
                        console.log('Could not reacquire wake lock:', err);
                    }
                }
            });
        };

        function exportBackup() {
            const backup = {
                version: 4,
                exportDate: new Date().toISOString(),
                recipes: recipes,
                categories: categories,
                groceryItems: groceryItems
            };

            const dataStr = JSON.stringify(backup, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `recipe-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('Backup downloaded!');
        }

        async function importBackup(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const backup = JSON.parse(e.target.result);
                    
                    if (confirm('This will replace all current recipes. Continue?')) {
                        recipes = backup.recipes || [];
                        categories = backup.categories || categories;
                        groceryItems = backup.groceryItems || [];
                        
                        await saveRecipesToDB();
                        await saveCategoriesToDB();
                        await saveGroceryListToDB();
                        updateCategoryCounts();
                        updateCategoryDropdown();
                        showCategories();
                        
                        alert('Backup imported successfully!');
                    }
                } catch (err) {
                    alert('Error importing backup: ' + err.message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        async function handleCardImageUpload(event, cardNum, side) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.size > 10 * 1024 * 1024) {
                alert('Image size should be less than 10MB');
                return;
            }

            try {
                const compressedImage = await compressImage(file);
                tempCards[cardNum - 1][side] = compressedImage;
                
                const area = document.getElementById(`card${cardNum}${side.charAt(0).toUpperCase() + side.slice(1)}Area`);
                area.classList.add('has-image');
                area.innerHTML = `
                    <img src="${compressedImage}" class="image-preview">
                    <button class="remove-image" onclick="removeCardImage(event, ${cardNum}, '${side}')">√ó</button>
                `;
            } catch (error) {
                alert('Error processing image: ' + error.message);
            }
        }

        function removeCardImage(event, cardNum, side) {
            event.stopPropagation();
            tempCards[cardNum - 1][side] = null;
            
            const area = document.getElementById(`card${cardNum}${side.charAt(0).toUpperCase() + side.slice(1)}Area`);
            const input = document.getElementById(`card${cardNum}${side.charAt(0).toUpperCase() + side.slice(1)}Input`);
            
            area.classList.remove('has-image');
            area.innerHTML = '<span>üì∑</span>';
            input.value = '';
        }

        let currentCategoryKey = null;

        function showCategoryMenu(event, key) {
            event.stopPropagation();
            currentCategoryKey = key;
            
            const menu = document.getElementById('categoryActionMenu');
            const rect = event.target.getBoundingClientRect();
            
            // Position menu near the clicked button
            menu.style.top = (rect.bottom + window.scrollY + 5) + 'px';
            menu.style.left = (rect.left + window.scrollX - 50) + 'px';
            
            menu.classList.add('active');
            
            // Close menu when clicking outside
            setTimeout(() => {
                document.addEventListener('click', closeCategoryMenuOnOutsideClick);
            }, 10);
        }

        function closeCategoryMenu() {
            const menu = document.getElementById('categoryActionMenu');
            menu.classList.remove('active');
            currentCategoryKey = null;
            document.removeEventListener('click', closeCategoryMenuOnOutsideClick);
        }

        function closeCategoryMenuOnOutsideClick(event) {
            const menu = document.getElementById('categoryActionMenu');
            if (!menu.contains(event.target)) {
                closeCategoryMenu();
            }
        }

        async function editCategoryFromMenu() {
            if (!currentCategoryKey) return;
            
            // Save the key before closing menu (which sets currentCategoryKey to null)
            const categoryKey = currentCategoryKey;
            closeCategoryMenu();
            
            const cat = categories[categoryKey];
            
            const newName = prompt('Enter new category name:', cat.name);
            if (newName === null) return; // Cancelled
            if (!newName.trim()) return; // Empty
            
            const newIcon = prompt('Enter new emoji icon:', cat.icon);
            if (newIcon === null) return; // Cancelled
            if (!newIcon) return; // Empty
            
            cat.name = newName.trim();
            cat.icon = newIcon;
            
            await saveCategoriesToDB();
            updateCategoryDropdown();
            showCategories();
        }

        async function deleteCategoryFromMenu() {
            if (!currentCategoryKey) return;
            
            // Save the key before closing menu (which sets currentCategoryKey to null)
            const categoryKey = currentCategoryKey;
            closeCategoryMenu();
            
            const cat = categories[categoryKey];
            
            if (cat.count > 0) {
                alert(`Cannot delete "${cat.name}" - it contains ${cat.count} recipe(s). Move recipes to other categories first.`);
            } else if (confirm(`Are you sure you want to delete "${cat.name}"? This cannot be undone.`)) {
                delete categories[categoryKey];
                await saveCategoriesToDB();
                updateCategoryDropdown();
                showCategories();
            }
        }

        async function deleteCategory(event, key) {
            event.stopPropagation();
            const cat = categories[key];
            
            if (cat.count > 0) {
                alert(`Cannot delete "${cat.name}" - it contains ${cat.count} recipe(s).`);
                return;
            }
            
            if (confirm(`Delete "${cat.name}" category?`)) {
                delete categories[key];
                await saveCategoriesToDB();
                updateCategoryDropdown();
                showCategories();
            }
        }

        function updateCategoryCounts() {
            Object.keys(categories).forEach(key => {
                categories[key].count = 0;
            });
            
            recipes.forEach(recipe => {
                if (categories[recipe.category]) {
                    categories[recipe.category].count++;
                }
            });
        }

        function updateCategoryDropdown() {
            const select = document.getElementById('recipeCategory');
            if (!select) return;
            
            select.innerHTML = '';
            Object.keys(categories).forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = categories[key].name;
                select.appendChild(option);
            });
        }

        function showView(view, param = null) {
            // Save previous view when navigating TO a recipe
            if (view === 'recipe') {
                previousView = currentView;
                previousCategory = currentCategory;
            } else {
                // For other navigations, only save if not already coming from a recipe
                if (currentView !== 'recipe') {
                    previousView = currentView;
                    previousCategory = currentCategory;
                }
                releaseWakeLock();
            }
            
            currentView = view;
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (view === 'categories') {
                document.querySelectorAll('.nav-btn')[0].classList.add('active');
                showCategories();
            } else if (view === 'all') {
                document.querySelectorAll('.nav-btn')[1].classList.add('active');
                showAllRecipes();
            } else if (view === 'favorites') {
                document.querySelectorAll('.nav-btn')[2].classList.add('active');
                showFavorites();
            } else if (view === 'grocery') {
                document.querySelectorAll('.nav-btn')[3].classList.add('active');
                showGroceryList();
            } else if (view === 'category') {
                currentCategory = param;
                showCategoryRecipes(param);
            } else if (view === 'recipe') {
                currentRecipe = param;
                showRecipeDetail(param);
            }
        }

        function showCategories() {
            currentView = 'categories';
            const content = document.getElementById('mainContent');
            let html = '<div class="category-grid">';
            
            const sortedCategories = Object.keys(categories).sort((a, b) => 
                categories[a].name.localeCompare(categories[b].name)
            );
            
            sortedCategories.forEach(key => {
                const cat = categories[key];
                html += `
                    <div class="category-card" onclick="showView('category', '${key}')">
                        <div class="category-actions">
                            <div class="category-action-btn" onclick="showCategoryMenu(event, '${key}')">‚ò∞</div>
                        </div>
                        <div class="category-icon">${cat.icon}</div>
                        <div class="category-name">${cat.name}</div>
                        <div class="category-count">${cat.count} recipes</div>
                    </div>
                `;
            });
            
            html += `
                <div class="category-card add-category-card" onclick="addNewCategory()">
                    <div class="category-icon">+</div>
                    <div class="category-name">Add Category</div>
                    <div class="category-count" style="color: rgba(255,255,255,0.9);">Create new</div>
                </div>
            `;
            
            html += '</div>';
            content.innerHTML = html;
        }

        async function addNewCategory() {
            const name = prompt('Enter the name for the new category:');
            if (!name || !name.trim()) return;
            
            const icon = prompt('Enter an emoji icon:') || 'üìÇ';
            const key = name.toLowerCase().replace(/[^a-z0-9]/g, '');
            
            if (categories[key]) {
                alert('A category with this name already exists!');
                return;
            }
            
            categories[key] = {
                name: name.trim(),
                icon: icon,
                count: 0
            };
            
            await saveCategoriesToDB();
            showCategories();
            updateCategoryDropdown();
        }

        function showAllRecipes() {
            const content = document.getElementById('mainContent');
            let html = '<div class="recipe-grid">';
            
            const sortedRecipes = [...recipes].sort((a, b) => 
                a.title.localeCompare(b.title)
            );
            
            sortedRecipes.forEach(recipe => {
                html += createRecipeCard(recipe);
            });
            
            html += `
                <div class="recipe-card add-recipe-card" onclick="openModal()">
                    <div class="add-icon">+</div>
                    <div>Add New Recipe</div>
                </div>
            `;
            
            html += '</div>';
            content.innerHTML = html;
        }

        function showFavorites() {
            const content = document.getElementById('mainContent');
            const favoriteRecipes = recipes.filter(r => r.favorite);
            
            if (favoriteRecipes.length === 0) {
                content.innerHTML = '<div style="text-align: center; padding: 50px; color: #666;">No favorite recipes yet!</div>';
                return;
            }
            
            const sortedFavorites = favoriteRecipes.sort((a, b) => 
                a.title.localeCompare(b.title)
            );
            
            let html = '<div class="recipe-grid">';
            sortedFavorites.forEach(recipe => {
                html += createRecipeCard(recipe);
            });
            html += '</div>';
            content.innerHTML = html;
        }

        function showCategoryRecipes(category) {
            const content = document.getElementById('mainContent');
            const categoryRecipes = recipes.filter(r => r.category === category);
            const cat = categories[category];
            
            const sortedRecipes = categoryRecipes.sort((a, b) => 
                a.title.localeCompare(b.title)
            );
            
            let html = `
                <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 20px; flex-wrap: wrap;">
                    <button class="back-btn" onclick="showView('categories')" style="margin-bottom: 0;">‚Üê Back</button>
                    <button class="back-btn" onclick="openModal('${category}')" style="background: #28a745; color: white; border-color: #28a745; margin-bottom: 0;">+ Add New Recipe</button>
                </div>
                <h2 style="margin-bottom: 20px; color: #333;">${cat.icon} ${cat.name}</h2>
                <div class="recipe-grid">
            `;
            
            sortedRecipes.forEach(recipe => {
                html += createRecipeCard(recipe);
            });
            
            html += '</div>';
            content.innerHTML = html;
        }

        function createRecipeCard(recipe) {
            const firstCard = recipe.cards && recipe.cards[0];
            const imageContent = firstCard && firstCard.front
                ? `<img src="${firstCard.front}" alt="${recipe.title}">` 
                : 'üìã';
            
            const cardCount = recipe.cards ? recipe.cards.filter(c => c.front || c.back).length : 0;
            const isMultiCard = cardCount > 1;
            
            return `
                <div class="recipe-card ${isMultiCard ? 'multi-card' : ''}" onclick="showView('recipe', ${recipe.id})">
                    <span class="favorite-star ${recipe.favorite ? '' : 'unfilled'}" onclick="toggleFavorite(event, ${recipe.id})">‚òÖ</span>
                    <div class="recipe-card-image">${imageContent}</div>
                    <div class="recipe-title">${recipe.title}</div>
                    <div class="recipe-tags">
                        ${recipe.tags.map(tag => `<span class="recipe-tag">${tag}</span>`).join('')}
                    </div>
                </div>
            `;
        }

        function showRecipeDetail(recipeId) {
            const recipe = recipes.find(r => r.id === recipeId);
            if (!recipe) return;
            
            const content = document.getElementById('mainContent');
            
            let html = `
                <button class="back-btn" onclick="goBack()">‚Üê Back</button>
                <div class="recipe-action-buttons">
                    <button class="recipe-action-btn edit" onclick="editRecipe(${recipe.id})">‚úèÔ∏è Edit Recipe</button>
                </div>
                
                <div class="wake-lock-toggle" id="wakeLockToggle" onclick="toggleWakeLock()">
                    <span class="icon">‚òÄÔ∏è</span>
                    <span class="status-text">Keep Screen On</span>
                </div>
                
                <button class="add-grocery-btn" onclick="promptAddGroceryItem()" title="Add to grocery list">+</button>
                
                <div class="recipe-detail">
                    <div class="recipe-detail-header">
                        <h1 class="recipe-detail-title">${recipe.title}</h1>
                        ${recipe.voiceClip ? `
                            <div style="margin: 15px 0;">
                                <button onclick="playVoiceClip('${recipe.voiceClip}')" style="background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-size: 1em; display: flex; align-items: center; gap: 8px; margin: 0 auto;">
                                    üîä Hear the name
                                </button>
                            </div>
                        ` : ''}
                        <div class="recipe-tags">
                            ${recipe.tags.map(tag => `<span class="recipe-tag">${tag}</span>`).join('')}
                        </div>
                    </div>
                    <div class="recipe-cards-container">
            `;
            
            if (recipe.cards) {
                recipe.cards.forEach((card, index) => {
                    if (card.front || card.back) {
                        html += `
                            <div class="card-section">
                                <div class="card-section-title">Card ${index + 1}</div>
                                <div class="card-images">
                        `;
                        
                        if (card.front) {
                            html += `
                                <div class="recipe-image-container">
                                    <div class="recipe-image-full" onclick="openFullscreen('${card.front}')">
                                        <span class="image-label">Front</span>
                                        <img src="${card.front}" alt="Recipe card front">
                                    </div>
                                </div>
                            `;
                        }
                        
                        if (card.back) {
                            html += `
                                <div class="recipe-image-container">
                                    <div class="recipe-image-full" onclick="openFullscreen('${card.back}')">
                                        <span class="image-label">Back</span>
                                        <img src="${card.back}" alt="Recipe card back">
                                    </div>
                                </div>
                            `;
                        }
                        
                        html += `
                                </div>
                            </div>
                        `;
                    }
                });
            }
            
            html += `
                    </div>
                </div>
            `;
            content.innerHTML = html;
        }

        function playVoiceClip(url) {
            const audio = new Audio(url);
            audio.play().catch(err => {
                console.error('Error playing audio:', err);
                alert('Unable to play audio. Please check the URL.');
            });
        }

        function showGroceryList() {
            const content = document.getElementById('mainContent');
            
            let html = `
                <div class="grocery-list-container">
                    <h2 style="margin-bottom: 20px; color: #333;">üõí Grocery List</h2>
                    
                    <div class="grocery-input-section">
                        <input type="text" class="grocery-input" id="groceryItemInput" placeholder="Add item (e.g., butter, eggs)..." onkeypress="if(event.key==='Enter') addGroceryItem()">
                        <button class="grocery-add-btn" onclick="addGroceryItem()">Add</button>
                    </div>
                    
                    <div class="grocery-items" id="groceryItemsList">
            `;
            
            if (groceryItems.length === 0) {
                html += `
                    <div class="grocery-empty">
                        <div class="grocery-empty-icon">üìù</div>
                        <div>Your grocery list is empty</div>
                        <div style="font-size: 0.9em; margin-top: 10px;">Add items while browsing recipes!</div>
                    </div>
                `;
            } else {
                groceryItems.forEach(item => {
                    html += `
                        <div class="grocery-item ${item.checked ? 'checked' : ''}">
                            <input type="checkbox" ${item.checked ? 'checked' : ''} onchange="toggleGroceryItem(${item.id})">
                            <div class="grocery-item-text">${item.text}</div>
                            <button class="grocery-item-delete" onclick="deleteGroceryItem(${item.id})">√ó</button>
                        </div>
                    `;
                });
            }
            
            html += `
                    </div>
                    
                    ${groceryItems.length > 0 ? `
                        <div class="grocery-actions">
                            <button class="grocery-clear-btn" onclick="clearCompletedItems()">Clear Completed</button>
                            <button class="grocery-clear-btn danger" onclick="clearAllItems()">Clear All</button>
                        </div>
                    ` : ''}
                </div>
            `;
            
            content.innerHTML = html;
        }

        function addGroceryItem() {
            const input = document.getElementById('groceryItemInput');
            const text = input.value.trim();
            
            if (!text) return;
            
            const newItem = {
                id: Date.now(),
                text: text,
                checked: false
            };
            
            groceryItems.push(newItem);
            saveGroceryListToDB();
            input.value = '';
            showGroceryList();
        }

        function promptAddGroceryItem() {
            const item = prompt('What do you need from the store?');
            if (item && item.trim()) {
                const newItem = {
                    id: Date.now(),
                    text: item.trim(),
                    checked: false
                };
                
                groceryItems.push(newItem);
                saveGroceryListToDB();
                
                // Show a brief confirmation
                const btn = document.querySelector('.add-grocery-btn');
                const originalText = btn.textContent;
                btn.textContent = '‚úì';
                btn.style.background = '#28a745';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                }, 1000);
            }
        }

        async function toggleGroceryItem(id) {
            const item = groceryItems.find(i => i.id === id);
            if (item) {
                item.checked = !item.checked;
                await saveGroceryListToDB();
                showGroceryList();
            }
        }

        async function deleteGroceryItem(id) {
            groceryItems = groceryItems.filter(i => i.id !== id);
            await saveGroceryListToDB();
            showGroceryList();
        }

        async function clearCompletedItems() {
            const completedCount = groceryItems.filter(i => i.checked).length;
            if (completedCount === 0) {
                alert('No completed items to clear');
                return;
            }
            
            if (confirm(`Clear ${completedCount} completed item${completedCount > 1 ? 's' : ''}?`)) {
                groceryItems = groceryItems.filter(i => !i.checked);
                await saveGroceryListToDB();
                showGroceryList();
            }
        }

        async function clearAllItems() {
            if (confirm('Clear all items from grocery list?')) {
                groceryItems = [];
                await saveGroceryListToDB();
                showGroceryList();
            }
        }

        function goBack() {
            if (previousView === 'category' && previousCategory) {
                showView('category', previousCategory);
            } else if (previousView === 'favorites') {
                showView('favorites');
            } else if (previousView === 'all') {
                showView('all');
            } else if (previousView === 'grocery') {
                showView('grocery');
            } else {
                showView('categories');
            }
        }

        async function toggleFavorite(event, recipeId) {
            event.stopPropagation();
            const recipe = recipes.find(r => r.id === recipeId);
            if (recipe) {
                recipe.favorite = !recipe.favorite;
                await saveRecipesToDB();
                
                if (currentView === 'favorites') {
                    showFavorites();
                } else if (currentView === 'all') {
                    showAllRecipes();
                } else if (currentView === 'category') {
                    showCategoryRecipes(currentCategory);
                }
            }
        }

        function searchRecipes(query) {
            if (!query) {
                showView(currentView, currentCategory);
                return;
            }
            
            const filtered = recipes.filter(recipe => 
                recipe.title.toLowerCase().includes(query.toLowerCase()) ||
                recipe.tags.some(tag => tag.toLowerCase().includes(query.toLowerCase()))
            );
            
            const content = document.getElementById('mainContent');
            if (filtered.length === 0) {
                content.innerHTML = '<div style="text-align: center; padding: 50px; color: #666;">No recipes found.</div>';
                return;
            }
            
            let html = '<div class="recipe-grid">';
            filtered.forEach(recipe => {
                html += createRecipeCard(recipe);
            });
            html += '</div>';
            content.innerHTML = html;
        }

        function openModal(defaultCategory = null) {
            document.getElementById('addRecipeModal').classList.add('active');
            
            // Set the category dropdown to the default category if provided
            if (defaultCategory && categories[defaultCategory]) {
                document.getElementById('recipeCategory').value = defaultCategory;
            } else {
                document.getElementById('recipeCategory').value = Object.keys(categories)[0];
            }
            
            tempCards = [
                { front: null, back: null },
                { front: null, back: null },
                { front: null, back: null },
                { front: null, back: null }
            ];
        }

        function closeModal() {
            document.getElementById('addRecipeModal').classList.remove('active');
            
            document.querySelector('.modal-header').textContent = 'Add New Recipe Card';
            const saveBtn = document.querySelector('.btn-save');
            saveBtn.textContent = 'Save Recipe';
            saveBtn.onclick = function() { saveRecipe(); };
            
            const deleteBtn = document.getElementById('deleteRecipeBtn');
            deleteBtn.style.display = 'none';
            
            document.getElementById('recipeTitle').value = '';
            document.getElementById('recipeTags').value = '';
            document.getElementById('recipeCategory').value = Object.keys(categories)[0];
            document.getElementById('recipeVoiceClip').value = '';
            
            for (let i = 1; i <= 4; i++) {
                ['Front', 'Back'].forEach(side => {
                    const area = document.getElementById(`card${i}${side}Area`);
                    const input = document.getElementById(`card${i}${side}Input`);
                    if (area && input) {
                        area.classList.remove('has-image');
                        area.innerHTML = '<span>üì∑</span>';
                        input.value = '';
                    }
                });
            }
            
            tempCards = [
                { front: null, back: null },
                { front: null, back: null },
                { front: null, back: null },
                { front: null, back: null }
            ];
        }

        async function saveRecipe() {
            const title = document.getElementById('recipeTitle').value;
            const category = document.getElementById('recipeCategory').value;
            const tags = document.getElementById('recipeTags').value.split(',').map(t => t.trim()).filter(t => t);
            const voiceClip = document.getElementById('recipeVoiceClip').value.trim();
            
            if (!title) {
                alert('Please enter a recipe title');
                return;
            }
            
            const cards = tempCards.filter(card => card.front || card.back);
            
            if (cards.length === 0) {
                alert('Please upload at least one card image');
                return;
            }
            
            const newRecipe = {
                id: Date.now(),
                title: title,
                category: category,
                tags: tags.length > 0 ? tags : ['untagged'],
                favorite: false,
                voiceClip: voiceClip || null,
                cards: cards
            };
            
            recipes.push(newRecipe);
            updateCategoryCounts();
            await saveRecipesToDB();
            await saveCategoriesToDB();
            closeModal();
            
            showView('recipe', newRecipe.id);
        }

        async function editRecipe(recipeId) {
            const recipe = recipes.find(r => r.id === recipeId);
            if (!recipe) return;
            
            document.getElementById('recipeTitle').value = recipe.title;
            document.getElementById('recipeCategory').value = recipe.category;
            document.getElementById('recipeTags').value = recipe.tags.join(', ');
            document.getElementById('recipeVoiceClip').value = recipe.voiceClip || '';
            
            tempCards = [
                { front: null, back: null },
                { front: null, back: null },
                { front: null, back: null },
                { front: null, back: null }
            ];
            
            if (recipe.cards) {
                recipe.cards.forEach((card, index) => {
                    if (index < 4) {
                        tempCards[index] = { ...card };
                        
                        if (card.front) {
                            const area = document.getElementById(`card${index + 1}FrontArea`);
                            area.classList.add('has-image');
                            area.innerHTML = `
                                <img src="${card.front}" class="image-preview">
                                <button class="remove-image" onclick="removeCardImage(event, ${index + 1}, 'front')">√ó</button>
                            `;
                        }
                        
                        if (card.back) {
                            const area = document.getElementById(`card${index + 1}BackArea`);
                            area.classList.add('has-image');
                            area.innerHTML = `
                                <img src="${card.back}" class="image-preview">
                                <button class="remove-image" onclick="removeCardImage(event, ${index + 1}, 'back')">√ó</button>
                            `;
                        }
                    }
                });
            }
            
            document.querySelector('.modal-header').textContent = 'Edit Recipe Card';
            const saveBtn = document.querySelector('.btn-save');
            saveBtn.textContent = 'Update Recipe';
            saveBtn.onclick = function() { updateRecipe(recipeId); };
            
            const deleteBtn = document.getElementById('deleteRecipeBtn');
            deleteBtn.style.display = 'inline-block';
            deleteBtn.onclick = function() { deleteRecipeFromModal(recipeId); };
            
            document.getElementById('addRecipeModal').classList.add('active');
        }

        async function updateRecipe(recipeId) {
            const recipe = recipes.find(r => r.id === recipeId);
            if (!recipe) return;
            
            const title = document.getElementById('recipeTitle').value;
            const category = document.getElementById('recipeCategory').value;
            const tags = document.getElementById('recipeTags').value.split(',').map(t => t.trim()).filter(t => t);
            const voiceClip = document.getElementById('recipeVoiceClip').value.trim();
            
            if (!title) {
                alert('Please enter a recipe title');
                return;
            }
            
            const cards = tempCards.filter(card => card.front || card.back);
            
            if (cards.length === 0) {
                alert('Please upload at least one card image');
                return;
            }
            
            recipe.title = title;
            recipe.category = category;
            recipe.tags = tags.length > 0 ? tags : ['untagged'];
            recipe.voiceClip = voiceClip || null;
            recipe.cards = cards;
            
            updateCategoryCounts();
            await saveRecipesToDB();
            await saveCategoriesToDB();
            closeModal();
            
            showView('recipe', recipeId);
        }

        async function deleteRecipe(recipeId) {
            if (confirm('Are you sure you want to delete this recipe?')) {
                recipes = recipes.filter(r => r.id !== recipeId);
                updateCategoryCounts();
                await saveRecipesToDB();
                await saveCategoriesToDB();
                goBack();
            }
        }

        async function deleteRecipeFromModal(recipeId) {
            if (confirm('Are you sure you want to delete this recipe? This cannot be undone.')) {
                recipes = recipes.filter(r => r.id !== recipeId);
                updateCategoryCounts();
                await saveRecipesToDB();
                await saveCategoriesToDB();
                closeModal();
                goBack();
            }
        }

        function openFullscreen(imageSrc) {
            const overlay = document.getElementById('fullscreenOverlay');
            const img = document.getElementById('fullscreenImage');
            img.src = imageSrc;
            overlay.classList.add('active');
        }

        function closeFullscreen() {
            const overlay = document.getElementById('fullscreenOverlay');
            overlay.classList.remove('active');
        }

        async function toggleWakeLock() {
            const recipeToggle = document.getElementById('wakeLockToggle');
            const fullscreenToggle = document.getElementById('fullscreenWakeLock');
            
            if (!('wakeLock' in navigator)) {
                alert('Screen wake lock not supported.');
                return;
            }

            if (wakeLock !== null) {
                releaseWakeLock();
            } else {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                    
                    // Update both toggles
                    [recipeToggle, fullscreenToggle].forEach(toggle => {
                        if (toggle) {
                            toggle.classList.add('active');
                            const statusText = toggle.querySelector('.status-text');
                            if (statusText) statusText.textContent = 'Screen Staying On';
                        }
                    });
                    
                    wakeLock.addEventListener('release', () => {
                        wakeLock = null;
                        [recipeToggle, fullscreenToggle].forEach(toggle => {
                            if (toggle) {
                                toggle.classList.remove('active');
                                const statusText = toggle.querySelector('.status-text');
                                if (statusText) statusText.textContent = 'Keep Screen On';
                            }
                        });
                    });
                } catch (err) {
                    alert(`Unable to keep screen on: ${err.message}`);
                }
            }
        }

        function releaseWakeLock() {
            if (wakeLock !== null) {
                wakeLock.release();
                wakeLock = null;
                
                const recipeToggle = document.getElementById('wakeLockToggle');
                const fullscreenToggle = document.getElementById('fullscreenWakeLock');
                
                [recipeToggle, fullscreenToggle].forEach(toggle => {
                    if (toggle) {
                        toggle.classList.remove('active');
                        const statusText = toggle.querySelector('.status-text');
                        if (statusText) statusText.textContent = 'Keep Screen On';
                    }
                });
            }
        }

        window.onclick = function(event) {
            const modal = document.getElementById('addRecipeModal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>
